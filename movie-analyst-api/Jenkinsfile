node {
    step([$class: 'WsCleanup'])

    stage('Checkout scm') {
        checkout scm
    }

    stage('Run test') {
        dir ('movie-analyst-api') {
            withEnv([
                'PORT=3000',
                'DB_HOST=db',
                'DB_USER=applicationuser',
                'DB_PASS=applicationuser',
                'DB_NAME=movie_db'
            ]) {
                docker.image('mysql:5').withRun('-e "MYSQL_ROOT_PASSWORD=applicationuser"') {c ->
                    docker.image('node:10.11.0-alpine').inside {
                        echo 'Performing tests'
                        sh 'npm install'
                        sh 'npm test'
                    }
                }
            }
        }
    }

    stage('Build docker image') {
        echo "Not yet"
    }
}