node {

    environment {
        registryCredentials = 'docker-hub'
        dockerImage = ''
    }

    step([$class: 'WsCleanup'])

    stage('Checkout scm') {
        checkout scm
    }

    stage('Run test') {
        dir ('movie-analyst-api') {
            docker.image('node:10.11.0-alpine').inside {
                echo 'Performing tests'
                sh 'npm install'
                sh 'npm test'
            }
        }
    }

    stage('Build docker image') {
        dir ('movie-analyst-api') {
            echo "Building docker image"
            dockerImage = docker.build("my-nodejs-image")
        }
    }

    stage('Publish docker image') {
        docker.withRegistry('', registryCredentials) {
            dockerImage.push("$BUILD_NUMBER")
        }
    }
}